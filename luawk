#!/usr/bin/env lua

json = require"dkjson"

local prep = {}
local post = {}
local function applyall(arr, _)
  for i, f in ipairs(arr) do
    _ = f(_)
  end
  return _
end

local cmd = "true"
carg = arg[1]
local shift = function()
  table.remove(arg,1)
  carg = arg[1]
end

local process = function() end
while true do
  if not carg then break end
  if carg == "-j" then -- process json records
    prep[#prep+1] = json.decode
    post[#post+1] = json.encode
  elseif carg == "-p" then -- print out results after processing
    post[#post+1] = print
  elseif carg == "-e" then
    shift()
    process, err = loadstring(carg)
  elseif carg == "-f" then
    shift()
    process, err = loadfile(carg)
  end
  shift()
end
if not process then error(err) end

for l in io.lines() do
  -- _ needs to be global, not shadowed by loop variable in this block
  _ = applyall(prep, l)
  process()
  applyall(post, _)
end
